<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YouTube Family Payment Tracker (Multi-Year)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    .dot{width:10px;height:10px;border-radius:9999px;display:inline-block}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">YouTube Family Payment Tracker</h1>
        <p class="text-sm text-slate-500">Supports multiple years — live Google Drive sync</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="exportExcelBtn" class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm hover:bg-green-700">Export Excel</button>
        <button id="forceSaveBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">Save Now</button>
        <button id="resetAllBtn" class="px-3 py-2 rounded-lg bg-red-50 text-red-700 text-sm border border-red-200 hover:bg-red-100">Reset</button>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-3">General</h2>
        <div class="flex gap-3 items-center mb-3">
          <label class="text-sm w-28">Currency</label>
          <input id="currencyInput" type="text" maxlength="5" class="w-full border rounded-lg px-3 py-2" placeholder="e.g. MYR, USD">
        </div>
        <div class="flex gap-3 items-center">
          <label class="text-sm w-28">Monthly Amount</label>
          <input id="amountInput" type="number" min="0" step="0.01" class="w-full border rounded-lg px-3 py-2" placeholder="e.g. 10">
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-3">Members <span id="memberCount" class="text-xs text-slate-500"></span></h2>
        <div id="memberList" class="space-y-2 mb-3"></div>
        <div class="flex gap-2">
          <input id="newMemberName" type="text" class="flex-1 border rounded-lg px-3 py-2" placeholder="Add member name">
          <button id="addMemberBtn" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">Add</button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-3">Months / Years</h2>
        <div class="flex items-center gap-2 mb-3">
          <input id="addMonthInput" type="month" class="border rounded-lg px-3 py-2">
          <button id="addMonthBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700">Add Month</button>
        </div>
        <div class="flex items-center gap-2">
          <input id="genYearInput" type="number" min="2000" max="2100" class="border rounded-lg px-3 py-2 w-32" placeholder="Year e.g. 2025">
          <button id="genYearBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">Generate 12 Months</button>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow overflow-x-auto">
      <div class="flex items-center justify-between px-4 py-2 border-b">
        <div id="statusBar" class="text-sm text-slate-500 flex items-center gap-2">
          <span class="dot" id="statusDot" style="background:#aaa"></span>
          <span id="statusText">Idle</span>
        </div>
        <div class="text-xs text-slate-500">
          <span>File:</span> <span id="fileNameText" class="font-medium">youtube-family-tracker.json</span>
          <span class="ml-3">Endpoint:</span> <span id="endpointText" class="font-medium">/exec</span>
        </div>
      </div>
      <table class="min-w-full divide-y divide-slate-200">
        <thead id="tableHead" class="bg-slate-50"></thead>
        <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
        <tfoot id="tableFoot" class="bg-slate-50"></tfoot>
      </table>
    </section>
  </div>

<script>
const GAS_WEB_APP_URL="https://script.google.com/macros/s/AKfycbwG79b42uNepSLHQ09R9l--VrnnuYN3rON0ohMM82wdx3HRC-iMUuumdc6iuOCY0o2V/exec";
const DRIVE_FILE_NAME="youtube-family-tracker.json";

const el=id=>document.getElementById(id);
function setStatus(t,c){el("statusText").textContent=t;el("statusDot").style.background=c||"#aaa";}
const MAX_MEMBERS=6;
let state={currency:"MYR",monthlyAmount:10,members:[{id:crypto.randomUUID(),name:"Member 1",active:true}],months:[],payments:{}};
let saveTimer=null;

function scheduleSave(){setStatus("Saving…","#fbbf24");clearTimeout(saveTimer);saveTimer=setTimeout(remoteSave,800);}

async function remoteLoad(){
  setStatus("Loading…","#60a5fa");
  try{
    const url=new URL(GAS_WEB_APP_URL);
    url.searchParams.set("fileName",DRIVE_FILE_NAME);
    const res=await fetch(url);
    const data=await res.json();
    if(data?.state)state=data.state;
    setStatus("Loaded","#10b981");
  }catch(e){console.error(e);setStatus("Load failed","#ef4444");}
}

async function remoteSave(){
  try{
    await fetch(GAS_WEB_APP_URL+"?fileName="+encodeURIComponent(DRIVE_FILE_NAME),{
      method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({state})
    });
    setStatus("Saved","#10b981");
  }catch(e){console.error(e);setStatus("Save failed","#ef4444");}
}

function formatMonthLabel(ym){const[y,m]=ym.split("-").map(Number);return new Date(y,m-1,1).toLocaleString(undefined,{month:"short",year:"numeric"});}
function ensurePaymentEntry(m){if(!state.payments[m])state.payments[m]={};state.members.forEach(x=>{if(state.payments[m][x.id]===undefined)state.payments[m][x.id]=false;});}
function sortMonths(){state.months.sort((a,b)=>a.localeCompare(b));}

function groupByYear(){
  const grouped={};
  state.months.forEach(m=>{
    const [y]=m.split("-");
    if(!grouped[y])grouped[y]=[];
    grouped[y].push(m);
  });
  return Object.keys(grouped).sort().map(y=>({year:y,months:grouped[y].sort()}));
}

function recalcFooters(){
  const tfoot=el("tableFoot");
  if(!state.months.length){tfoot.innerHTML="";return;}
  const totals={};state.members.forEach(m=>totals[m.id]=0);
  state.months.forEach(mon=>{const pm=state.payments[mon]||{};state.members.forEach(m=>{if(pm[m.id])totals[m.id]++;});});
  let row1="<tr><td class='px-4 py-2 font-semibold'>Paid Count</td>";
  state.members.forEach(m=>row1+=`<td class='px-4 py-2 text-center'>${totals[m.id]}</td>`);
  row1+="<td></td></tr>";
  let row2=`<tr><td class='px-4 py-2 font-semibold'>Total Paid (${state.currency})</td>`;
  state.members.forEach(m=>{const amt=(totals[m.id]*Number(state.monthlyAmount)).toFixed(2);row2+=`<td class='px-4 py-2 text-center'>${amt}</td>`;});
  row2+="<td></td></tr>";
  tfoot.innerHTML=row1+row2;
}

function renderTable(){
  const thead=el("tableHead"),tbody=el("tableBody");
  let head="<tr><th class='px-4 py-3 text-left text-xs font-semibold uppercase'>Month</th>";
  state.members.forEach(m=>{const cls=m.active?"text-slate-700":"text-slate-400 line-through";head+=`<th class='px-4 py-3 text-center text-xs font-semibold uppercase'><span class='${cls}'>${m.name}</span></th>`;});
  head+="<th class='px-4 py-3 text-right text-xs font-semibold uppercase'>Summary</th></tr>";
  thead.innerHTML=head;

  let body="";
  const groups=groupByYear();
  groups.forEach(g=>{
    body+=`<tr class='bg-slate-100'><td colspan='${state.members.length+2}' class='px-4 py-2 font-semibold'>${g.year}</td></tr>`;
    g.months.forEach(mon=>{
      ensurePaymentEntry(mon);
      const pm=state.payments[mon],paidCount=state.members.filter(m=>pm[m.id]).length;
      const due=state.members.length*state.monthlyAmount,col=paidCount*state.monthlyAmount,out=due-col;
      body+=`<tr><td class='px-4 py-2'>${formatMonthLabel(mon)}</td>`;
      state.members.forEach(m=>{
        const checked=pm[m.id]?"checked":"",dis=m.active?"":"disabled";
        body+=`<td class='px-4 py-2 text-center'><input type='checkbox' data-month='${mon}' data-member='${m.id}' class='paymentCheck w-5 h-5' ${checked} ${dis}></td>`;
      });
      body+=`<td class='px-4 py-2 text-right text-sm'>${state.currency} ${col.toFixed(2)} / ${due.toFixed(2)}<div class='text-xs ${out>0?"text-amber-600":"text-emerald-600"}'>${out>0?"Outstanding "+state.currency+" "+out.toFixed(2):"All paid"}</div></td></tr>`;
    });
  });
  tbody.innerHTML=body;

  document.querySelectorAll(".paymentCheck").forEach(cb=>cb.addEventListener("change",e=>{
    const mon=e.target.dataset.month,id=e.target.dataset.member;
    ensurePaymentEntry(mon);state.payments[mon][id]=e.target.checked;
    renderTable();scheduleSave();
  }));
  recalcFooters();
}

function renderMembersPanel(){
  const list=el("memberList");el("memberCount").textContent=`(${state.members.length}/${MAX_MEMBERS})`;
  list.innerHTML="";
  state.members.forEach(m=>{
    const div=document.createElement("div");
    div.className="flex items-center gap-2";
    div.innerHTML=`<input type='text' class='flex-1 border rounded-lg px-3 py-2 text-sm' value='${m.name}' data-id='${m.id}'>
    <label class='flex items-center gap-2 text-xs px-2 py-1 rounded border'><input type='checkbox' ${m.active?"checked":""} data-act='${m.id}'>Active</label>
    <button data-del='${m.id}' class='px-3 py-1 rounded-lg bg-red-50 text-red-700 text-xs border border-red-200'>Remove</button>`;
    list.appendChild(div);
  });
  list.querySelectorAll("[data-id]").forEach(inp=>inp.onchange=e=>{
    const id=e.target.dataset.id;const m=state.members.find(x=>x.id===id);if(m){m.name=e.target.value;renderTable();scheduleSave();}
  });
  list.querySelectorAll("[data-act]").forEach(cb=>cb.onchange=e=>{
    const id=e.target.dataset.act;const m=state.members.find(x=>x.id===id);if(m){m.active=e.target.checked;renderTable();scheduleSave();}
  });
  list.querySelectorAll("[data-del]").forEach(btn=>btn.onclick=e=>{
    const id=e.target.dataset.del;if(state.members.length<=1)return alert("At least one member required");
    state.members=state.members.filter(x=>x.id!==id);
    Object.keys(state.payments).forEach(mon=>delete state.payments[mon][id]);
    renderMembersPanel();renderTable();scheduleSave();
  });
  el("addMemberBtn").disabled=state.members.length>=MAX_MEMBERS;
}

function setupEvents(){
  el("currencyInput").onchange=e=>{state.currency=(e.target.value||"MYR").toUpperCase();renderTable();scheduleSave();}
  el("amountInput").onchange=e=>{state.monthlyAmount=Number(e.target.value)||0;renderTable();scheduleSave();}
  el("addMemberBtn").onclick=()=>{
    const name=el("newMemberName").value.trim();if(!name)return alert("Enter name");
    if(state.members.length>=MAX_MEMBERS)return alert("Max 6");
    state.members.push({id:crypto.randomUUID(),name,active:true});
    state.months.forEach(ensurePaymentEntry);
    el("newMemberName").value="";renderMembersPanel();renderTable();scheduleSave();
  };
  el("addMonthBtn").onclick=()=>{
    const mon=el("addMonthInput").value;if(!mon)return alert("Pick a month");
    if(!state.months.includes(mon))state.months.push(mon);
    sortMonths();ensurePaymentEntry(mon);renderTable();scheduleSave();
  };
  el("genYearBtn").onclick=()=>{
    const y=Number(el("genYearInput").value);if(!y)return alert("Enter year");
    for(let m=1;m<=12;m++){const ym=`${y}-${String(m).padStart(2,"0")}`;if(!state.months.includes(ym))state.months.push(ym);}
    sortMonths();state.months.forEach(ensurePaymentEntry);renderTable();scheduleSave();
  };
  el("exportExcelBtn").onclick=()=>{
    if(!state.months.length)return alert("No months");
    const rows=[["Month",...state.members.map(m=>m.name),"Collected","Due","Outstanding"]];
    state.months.forEach(mon=>{
      ensurePaymentEntry(mon);
      const pm=state.payments[mon],paid=state.members.filter(m=>pm[m.id]).length;
      const due=state.members.length*state.monthlyAmount,col=paid*state.monthlyAmount,out=due-col;
      const row=[formatMonthLabel(mon)];
      state.members.forEach(m=>row.push(pm[m.id]?"PAID":""));
      row.push(col.toFixed(2),due.toFixed(2),out.toFixed(2));
      rows.push(row);
    });
    const ws=XLSX.utils.aoa_to_sheet(rows);const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Payments");
    XLSX.writeFile(wb,"youtube-family-tracker.xlsx");
  };
  el("resetAllBtn").onclick=async()=>{
    if(!confirm("Reset all data?"))return;
    state={currency:"MYR",monthlyAmount:10,members:[{id:crypto.randomUUID(),name:"Member 1",active:true}],months:[],payments:{}};
    renderMembersPanel();renderTable();await remoteSave();
  };
  el("forceSaveBtn").onclick=remoteSave;
}

(async function init(){
  el("fileNameText").textContent=DRIVE_FILE_NAME;
  el("endpointText").textContent=GAS_WEB_APP_URL.includes("/exec")?"/exec":"(not /exec)";
  await remoteLoad();
  el("currencyInput").value=state.currency;
  el("amountInput").value=state.monthlyAmount;
  renderMembersPanel();renderTable();setupEvents();
})();
</script>
</body>
</html>
